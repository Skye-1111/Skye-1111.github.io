# 激光雷达树木检测系统 - 远程控制版本

基于HOKUYO URG-04LX-UG01激光雷达和STP-23L单点测距传感器的实时树木检测系统，支持WebSocket实时数据同步和蓝牙远程控制。

## 🚀 新功能特性

- 🌲 **实时树木检测**：基于DBSCAN聚类算法的圆形拟合树木识别
- 📏 **高度测量**：STP-23L传感器实时测量装置高度
- 🌐 **实时同步**：WebSocket服务器支持多设备数据同步
- 📊 **数据可视化**：实时扫描点云和检测结果可视化
- 💾 **数据管理**：支持数据导入导出和历史记录
- 🔄 **多设备协作**：支持多个设备同时连接和协作
- 📱 **远程控制**：通过蓝牙HC-05模块实现远程控制
- 🌍 **无显示器运行**：林场设备端无需连接显示器

## 系统要求

### 硬件要求

#### 林场设备端（Ubuntu迷你PC）
- HOKUYO URG-04LX-UG01 激光雷达
- STP-23L 单点测距传感器
- HC-05 蓝牙模块
- Ubuntu 18.04+ 操作系统
- 至少2个USB端口

#### 远程控制端
- 支持蓝牙的电脑/手机
- 现代Web浏览器（Chrome 89+, Edge 89+, Firefox 89+）

### 软件要求
- Node.js 14.0.0 或更高版本
- npm 6.0.0 或更高版本
- 现代Web浏览器（Chrome 89+, Edge 89+, Firefox 89+）

## 安装和运行

### 1. 克隆项目
```bash
git clone https://github.com/xjy231101217/lasercode.git
cd lasercode
```

### 2. 安装依赖
```bash
npm install
```

### 3. 启动WebSocket服务器
```bash
# 开发模式（自动重启）
npm run dev

# 生产模式
npm start
```

服务器将在以下地址启动：
- HTTP服务器：http://localhost:8080
- WebSocket服务器：ws://localhost:8080/ws

### 4. 启动远程控制系统

#### Linux/Ubuntu系统
```bash
# 启动完整系统（推荐）
./start-remote-system.sh

# 或者分别启动
npm start          # 启动WebSocket服务器
npm run bridge     # 启动蓝牙桥接器
```

#### Windows系统
```cmd
REM 启动完整系统
start-remote-system.bat

REM 或者分别启动
npm start          # 启动WebSocket服务器
npm run bridge     # 启动蓝牙桥接器
```

### 5. 访问系统
- **本地访问**：http://localhost:8080
- **远程访问**：https://xjy231101217.github.io/lasercode/

## 使用说明

### 远程控制设置

#### 1. 林场设备端设置
1. **硬件连接**：
   - 将激光雷达连接到USB端口1
   - 将STP-23L传感器连接到USB端口2
   - 将HC-05蓝牙模块连接到USB端口3

2. **启动系统**：
   ```bash
   ./start-remote-system.sh
   ```

3. **验证连接**：
   - WebSocket服务器运行在端口8080
   - 蓝牙桥接器自动扫描HC-05设备
   - 系统日志显示连接状态

#### 2. 远程控制端设置
1. **蓝牙连接**：
   - 在电脑/手机上启用蓝牙
   - 搜索并连接到HC-05设备
   - 配对密码：1234（默认）

2. **网页访问**：
   - 打开浏览器
   - 访问：https://xjy231101217.github.io/lasercode/
   - 等待WebSocket连接建立

3. **远程控制**：
   - 使用"远程控制"面板中的按钮
   - 实时查看设备状态和数据
   - 监控系统日志

### 本地设备连接（可选）

1. **连接激光雷达**：
   - 将HOKUYO URG-04LX-UG01通过USB连接到计算机
   - 点击"连接激光雷达"按钮
   - 选择对应的串口设备

2. **连接STP-23L传感器**：
   - 将STP-23L传感器连接到串口
   - 点击"连接STP-23L"按钮
   - 选择对应的串口设备

### 开始测量

1. **激光雷达扫描**：
   - 点击"开始扫描"进行连续扫描
   - 或点击"单次扫描"进行一次性扫描
   - 扫描完成后点击"检测树木"进行树木识别

2. **高度测量**：
   - 点击"开始测量"开始连续高度测量
   - 系统会实时显示当前高度和平均高度

### 数据同步

系统自动通过WebSocket连接进行实时数据同步：

- **扫描数据同步**：每次扫描完成后自动同步到服务器
- **树木数据同步**：检测到树木后自动同步检测结果
- **高度数据同步**：高度测量数据实时同步
- **状态同步**：设备连接状态实时更新

### 多设备协作

1. **多设备连接**：
   - 多个设备可以同时连接到同一个WebSocket服务器
   - 每个设备的数据会自动同步到其他设备

2. **数据共享**：
   - 所有设备的扫描数据、树木检测结果和高度测量数据都会实时共享
   - 可以在日志中查看其他设备的活动

## 配置参数

### 检测参数
- **聚类半径 (epsilon)**：DBSCAN算法的聚类半径，默认90mm
- **最小点数 (minPts)**：聚类的最小点数，默认6
- **最小半径**：树木检测的最小半径，默认50mm
- **最大半径**：树木检测的最大半径，默认450mm

### 高度测量参数
- **高度阈值**：高度变化检测阈值，默认1000mm

## 数据管理

### 导入数据
- 支持导入.txt和.csv格式的激光雷达数据文件
- 点击"选择数据文件"选择文件，然后点击"导入数据"

### 导出数据
- **导出数据**：导出原始扫描数据
- **导出树木信息**：导出检测到的树木信息
- **导出高度数据**：导出高度测量数据

## 故障排除

### 常见问题

1. **设备连接失败**：
   - 检查设备是否正确连接
   - 确认串口权限设置
   - 尝试重新插拔设备

2. **WebSocket连接失败**：
   - 检查服务器是否正在运行
   - 确认端口8080未被占用
   - 检查防火墙设置

3. **浏览器兼容性**：
   - 确保使用支持Web Serial API的浏览器
   - Chrome和Edge浏览器支持最佳

### 日志查看
系统日志会显示在页面底部的日志区域，包括：
- 设备连接状态
- 扫描和检测结果
- WebSocket连接状态
- 错误信息

## 技术架构

### 前端技术
- 原生JavaScript ES6+
- Canvas 2D API用于数据可视化
- Web Serial API用于串口通信
- WebSocket API用于实时通信

### 后端技术
- Node.js
- WebSocket (ws库)
- HTTP服务器

### 算法
- DBSCAN聚类算法用于点云聚类
- 最小二乘法圆形拟合用于树木识别

## 开发说明

### 项目结构
```
lasercode/
├── index.html              # 主页面
├── lidar-system.js         # 前端系统代码
├── websocket-server.js     # WebSocket服务器
├── package.json            # 项目配置
├── README.md              # 使用说明
└── data/                  # 数据存储目录
    └── lidar_data.json    # 历史数据文件
```

### 扩展开发
- 可以扩展更多的传感器支持
- 可以添加更多的数据分析和可视化功能
- 可以集成数据库进行数据持久化

## 许可证

MIT License

## 联系方式

如有问题或建议，请通过GitHub Issues联系。

---

**注意**：使用前请确保设备连接正确，并按照安全操作规程进行操作。
